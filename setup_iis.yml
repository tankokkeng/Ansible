---
- name: Configure Windows hostname, install IIS, disable IPv6, install Chocolatey and Git, and set up IIS site with code from GitHub
  hosts: IIS
  gather_facts: no

  tasks:
    - name: Set the hostname to "PG-IIS"
      ansible.windows.win_hostname:
        name: PG-IIS
      register: hostname_result

    - name: Display result of hostname change
      debug:
        var: hostname_result

    - name: Install IIS and IIS Management Console
      ansible.windows.win_feature:
        name:
          - Web-Server           # IIS
          - Web-Mgmt-Console     # IIS Management Console
        state: present
      register: iis_install_result

    - name: Display result of IIS and IIS Management Console installation
      debug:
        var: iis_install_result

    - name: Disable IPv6 on the NIC
      ansible.windows.win_regedit:
        path: 'HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters'
        name: DisabledComponents
        type: dword
        value: 0xFFFFFFFF  # Disables all IPv6 components
      register: disable_ipv6_result  # Ensure this is correctly indented

    - name: Display result of IPv6 disable task
      debug:
        var: disable_ipv6_result

    # Ensure Chocolatey is installed before using it to install Git
    - name: Install Chocolatey
      ansible.windows.win_chocolatey:
        name: chocolatey
        state: present

    - name: Install Git using Chocolatey
      ansible.windows.win_chocolatey:
        name: git
        state: present
      register: git_install_result

    - name: Display result of Git installation
      debug:
        var: git_install_result

    - name: Clone IIS website code from GitHub if not already present
      ansible.windows.win_command: |
        git clone https://github.com/AzureWorkshops/samples-simple-iis-website C:\inetpub\wwwroot\samples-simple-iis-website
      args:
        chdir: C:\inetpub\wwwroot
      register: git_clone_result
      ignore_errors: yes  # Ignore errors if repo already exists

    - name: Update IIS website code if already cloned
      ansible.windows.win_command: |
        git pull
      args:
        chdir: C:\inetpub\wwwroot\samples-simple-iis-website
      when: git_clone_result.failed  # Only run if the clone command failed (repo already exists)
      register: git_pull_result

    - name: Configure IIS site for the cloned website
      community.windows.win_iis_website:
        name: "SampleIISWebsite"
        physical_path: "C:\\inetpub\\wwwroot\\samples-simple-iis-website"
        state: started
        port: 80
      register: iis_site_result

    - name: Display result of IIS site configuration
      debug:
        var: iis_site_result
